// =============================================================================
// iMeetPro CI/CD Pipeline - Production Version
// =============================================================================
// Runs on Jenkins server directly (not in Kubernetes pods)
// Uses Docker on Jenkins server for builds, kubectl for deployments
// =============================================================================

pipeline {
    agent any  // Runs on Jenkins server
    
    environment {
        // AWS Configuration
        AWS_REGION = 'ap-south-1'
        AWS_ACCOUNT_ID = '664418964913'
        ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        
        // Repository names (matching your ECR repos)
        FRONTEND_REPO = "${ECR_REGISTRY}/imeetpro-prod/frontend"
        BACKEND_REPO = "${ECR_REGISTRY}/imeetpro-prod/backend"
        CELERY_REPO = "${ECR_REGISTRY}/imeetpro-prod/celery-worker"
        GPU_WORKER_REPO = "${ECR_REGISTRY}/imeetpro-prod/gpu-worker"
        
        // EKS Configuration
        EKS_CLUSTER_NAME = 'imeetpro-prod-eks'
        NAMESPACE = 'imeetpro'
        
        // Image Tag
        IMAGE_TAG = "${env.BUILD_NUMBER}"
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'staging', 'prod'],
            description: 'Target environment for deployment'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Skip test stage'
        )
        booleanParam(
            name: 'SKIP_SECURITY_SCAN',
            defaultValue: false,
            description: 'Skip security scan stage'
        )
        booleanParam(
            name: 'DEPLOY_FRONTEND',
            defaultValue: true,
            description: 'Deploy Frontend'
        )
        booleanParam(
            name: 'DEPLOY_BACKEND',
            defaultValue: true,
            description: 'Deploy Backend'
        )
        booleanParam(
            name: 'DEPLOY_CELERY',
            defaultValue: false,
            description: 'Deploy Celery Workers'
        )
        booleanParam(
            name: 'DEPLOY_GPU_WORKERS',
            defaultValue: false,
            description: 'Deploy GPU Workers'
        )
    }

    stages {
        // =====================================================================
        // Stage 1: Checkout
        // =====================================================================
        stage('Checkout') {
            steps {
                script {
                    echo "üîÑ Checking out source code..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        extensions: [[$class: 'CleanBeforeCheckout']],
                        userRemoteConfigs: [[
                            url: 'https://github.com/anumularoots-svg/iMeetProject.git',
                            credentialsId: 'github-credentials'
                        ]]
                    ])
                    currentBuild.description = "Env: ${params.ENVIRONMENT}, Tag: ${IMAGE_TAG}"
                }
            }
        }

        // =====================================================================
        // Stage 2: Setup AWS & kubectl
        // =====================================================================
        stage('Setup AWS') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials']]) {
                    sh '''
                        echo "üîß Configuring AWS and kubectl..."
                        aws sts get-caller-identity
                        aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER_NAME}
                        kubectl get nodes
                        echo "‚úÖ AWS and kubectl configured!"
                    '''
                }
            }
        }

        // =====================================================================
        // Stage 3: Build Docker Images
        // =====================================================================
        stage('Build Images') {
            parallel {
                stage('Build Frontend') {
                    when {
                        expression { params.DEPLOY_FRONTEND }
                    }
                    steps {
                        script {
                            echo "üèóÔ∏è Building Frontend Docker image..."
                            dir('frontend') {
                                sh """
                                    docker build \
                                        --build-arg VITE_API_URL=https://api.lancieretech.com \
                                        --build-arg VITE_LIVEKIT_URL=wss://imeetpro-fbrcr2mk.livekit.cloud \
                                        -t ${FRONTEND_REPO}:${IMAGE_TAG} \
                                        -t ${FRONTEND_REPO}:latest \
                                        -f Dockerfile .
                                """
                            }
                            echo "‚úÖ Frontend image built!"
                        }
                    }
                }
                
                stage('Build Backend') {
                    when {
                        expression { params.DEPLOY_BACKEND }
                    }
                    steps {
                        script {
                            echo "üèóÔ∏è Building Backend Docker image..."
                            dir('BackEnd') {
                                sh """
                                    docker build \
                                        -t ${BACKEND_REPO}:${IMAGE_TAG} \
                                        -t ${BACKEND_REPO}:latest \
                                        -f Dockerfile .
                                """
                            }
                            echo "‚úÖ Backend image built!"
                        }
                    }
                }
                
                stage('Build Celery') {
                    when {
                        expression { params.DEPLOY_CELERY }
                    }
                    steps {
                        script {
                            echo "üèóÔ∏è Building Celery Worker Docker image..."
                            // Celery uses same backend image
                            dir('BackEnd') {
                                sh """
                                    docker build \
                                        -t ${CELERY_REPO}:${IMAGE_TAG} \
                                        -t ${CELERY_REPO}:latest \
                                        -f Dockerfile .
                                """
                            }
                            echo "‚úÖ Celery image built!"
                        }
                    }
                }
                
                stage('Build GPU Worker') {
                    when {
                        expression { params.DEPLOY_GPU_WORKERS }
                    }
                    steps {
                        script {
                            echo "üèóÔ∏è Building GPU Worker Docker image..."
                            dir('BackEnd') {
                                sh """
                                    docker build \
                                        -t ${GPU_WORKER_REPO}:${IMAGE_TAG} \
                                        -t ${GPU_WORKER_REPO}:latest \
                                        -f Dockerfile.gpu .
                                """
                            }
                            echo "‚úÖ GPU Worker image built!"
                        }
                    }
                }
            }
        }

        // =====================================================================
        // Stage 4: Security Scan (Trivy)
        // =====================================================================
        stage('Security Scan') {
            when {
                expression { !params.SKIP_SECURITY_SCAN }
            }
            steps {
                script {
                    echo "üîí Running Trivy security scan..."
                    
                    if (params.DEPLOY_FRONTEND) {
                        sh """
                            trivy image --severity HIGH,CRITICAL --exit-code 0 \
                                ${FRONTEND_REPO}:${IMAGE_TAG} || true
                        """
                    }
                    
                    if (params.DEPLOY_BACKEND) {
                        sh """
                            trivy image --severity HIGH,CRITICAL --exit-code 0 \
                                ${BACKEND_REPO}:${IMAGE_TAG} || true
                        """
                    }
                    
                    if (params.DEPLOY_GPU_WORKERS) {
                        sh """
                            trivy image --severity HIGH,CRITICAL --exit-code 0 \
                                ${GPU_WORKER_REPO}:${IMAGE_TAG} || true
                        """
                    }
                    
                    echo "‚úÖ Security scan completed!"
                }
            }
        }

        // =====================================================================
        // Stage 5: Push to ECR
        // =====================================================================
        stage('Push to ECR') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials']]) {
                    script {
                        echo "üì§ Pushing images to ECR..."
                        
                        // Login to ECR
                        sh """
                            aws ecr get-login-password --region ${AWS_REGION} | \
                            docker login --username AWS --password-stdin ${ECR_REGISTRY}
                        """
                        
                        // Push Frontend
                        if (params.DEPLOY_FRONTEND) {
                            sh """
                                docker push ${FRONTEND_REPO}:${IMAGE_TAG}
                                docker push ${FRONTEND_REPO}:latest
                            """
                            echo "‚úÖ Frontend pushed!"
                        }
                        
                        // Push Backend
                        if (params.DEPLOY_BACKEND) {
                            sh """
                                docker push ${BACKEND_REPO}:${IMAGE_TAG}
                                docker push ${BACKEND_REPO}:latest
                            """
                            echo "‚úÖ Backend pushed!"
                        }
                        
                        // Push Celery
                        if (params.DEPLOY_CELERY) {
                            sh """
                                docker push ${CELERY_REPO}:${IMAGE_TAG}
                                docker push ${CELERY_REPO}:latest
                            """
                            echo "‚úÖ Celery pushed!"
                        }
                        
                        // Push GPU Worker
                        if (params.DEPLOY_GPU_WORKERS) {
                            sh """
                                docker push ${GPU_WORKER_REPO}:${IMAGE_TAG}
                                docker push ${GPU_WORKER_REPO}:latest
                            """
                            echo "‚úÖ GPU Worker pushed!"
                        }
                    }
                }
            }
        }

        // =====================================================================
        // Stage 6: Deploy to EKS
        // =====================================================================
        stage('Deploy to EKS') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials']]) {
                    script {
                        echo "üöÄ Deploying to EKS..."
                        
                        // Ensure kubectl is configured
                        sh "aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER_NAME}"
                        
                        // Check if deployments exist, if not apply manifests
                        sh """
                            kubectl get deployment frontend -n ${NAMESPACE} || \
                            kubectl apply -f kubernetes/apps/frontend/ -n ${NAMESPACE} || true
                            
                            kubectl get deployment backend -n ${NAMESPACE} || \
                            kubectl apply -f kubernetes/apps/backend/ -n ${NAMESPACE} || true
                        """
                        
                        // Deploy Frontend
                        if (params.DEPLOY_FRONTEND) {
                            echo "üöÄ Deploying Frontend..."
                            sh """
                                kubectl set image deployment/frontend \
                                    frontend=${FRONTEND_REPO}:${IMAGE_TAG} \
                                    -n ${NAMESPACE} || \
                                kubectl apply -f kubernetes/apps/frontend/ -n ${NAMESPACE}
                                
                                kubectl rollout status deployment/frontend \
                                    -n ${NAMESPACE} --timeout=300s || true
                            """
                        }
                        
                        // Deploy Backend
                        if (params.DEPLOY_BACKEND) {
                            echo "üöÄ Deploying Backend..."
                            sh """
                                kubectl set image deployment/backend \
                                    backend=${BACKEND_REPO}:${IMAGE_TAG} \
                                    -n ${NAMESPACE} || \
                                kubectl apply -f kubernetes/apps/backend/ -n ${NAMESPACE}
                                
                                kubectl rollout status deployment/backend \
                                    -n ${NAMESPACE} --timeout=300s || true
                            """
                        }
                        
                        // Deploy Celery Workers (uses backend image, module is SampleDB)
                        if (params.DEPLOY_CELERY) {
                            echo "üöÄ Deploying Celery Workers..."
                            sh """
                                # Apply celery deployment if not exists
                                kubectl get deployment celery-worker -n ${NAMESPACE} || \
                                kubectl apply -f kubernetes/apps/celery/ -n ${NAMESPACE}
                                
                                # Update celery-worker image
                                kubectl set image deployment/celery-worker \
                                    celery-worker=${BACKEND_REPO}:${IMAGE_TAG} \
                                    -n ${NAMESPACE} || true
                                
                                # Update celery-beat image
                                kubectl set image deployment/celery-beat \
                                    celery-beat=${BACKEND_REPO}:${IMAGE_TAG} \
                                    -n ${NAMESPACE} || true
                                
                                kubectl rollout status deployment/celery-worker \
                                    -n ${NAMESPACE} --timeout=300s || true
                            """
                        }
                        
                        // Deploy GPU Workers
                        if (params.DEPLOY_GPU_WORKERS) {
                            echo "üöÄ Deploying GPU Workers..."
                            sh """
                                # Apply GPU worker deployment if not exists
                                kubectl get deployment gpu-worker -n ${NAMESPACE} || \
                                kubectl apply -f kubernetes/apps/gpu-workers/ -n ${NAMESPACE}
                                
                                # Update GPU worker image
                                kubectl set image deployment/gpu-worker \
                                    gpu-worker=${GPU_WORKER_REPO}:${IMAGE_TAG} \
                                    -n ${NAMESPACE} || true
                                
                                kubectl rollout status deployment/gpu-worker \
                                    -n ${NAMESPACE} --timeout=600s || true
                            """
                        }
                        
                        echo "‚úÖ Deployment completed!"
                    }
                }
            }
        }

        // =====================================================================
        // Stage 7: Verify Deployment
        // =====================================================================
        stage('Verify') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials']]) {
                    sh '''
                        echo "============================================="
                        echo "        üîç DEPLOYMENT VERIFICATION"
                        echo "============================================="
                        echo ""
                        echo "=== Application Pods ==="
                        kubectl get pods -n ${NAMESPACE}
                        echo ""
                        echo "=== Services ==="
                        kubectl get svc -n ${NAMESPACE}
                        echo ""
                        echo "=== Ingress ==="
                        kubectl get ingress -n ${NAMESPACE}
                        echo ""
                        echo "=== Database Pods ==="
                        kubectl get pods -n databases
                        echo ""
                        echo "=== Recent Events ==="
                        kubectl get events -n ${NAMESPACE} --sort-by='.lastTimestamp' | tail -10
                        echo ""
                        echo "============================================="
                        echo "        ‚úÖ VERIFICATION COMPLETED"
                        echo "============================================="
                    '''
                }
            }
        }
    }

    post {
        success {
            echo """
            ‚úÖ ========================================
            ‚úÖ Pipeline completed successfully!
            ‚úÖ Environment: ${params.ENVIRONMENT}
            ‚úÖ Image Tag: ${IMAGE_TAG}
            ‚úÖ ========================================
            ‚úÖ Frontend:    https://www.lancieretech.com
            ‚úÖ Backend API: https://api.lancieretech.com
            ‚úÖ ========================================
            """
        }
        
        failure {
            echo """
            ‚ùå ========================================
            ‚ùå Pipeline failed!
            ‚ùå Check console output for details
            ‚ùå ========================================
            """
        }
        
        always {
            // Clean up Docker images to save space
            sh '''
                docker system prune -f || true
            '''
            cleanWs()
        }
    }
}
